<!doctype html>
<html lang="th" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap"
    rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      font-family: 'Prompt', sans-serif;
    }

    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }

    @keyframes skeleton-loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toast {
      animation: toastSlide 0.3s ease-out;
    }

    @keyframes toastSlide {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .btn-primary {
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(6, 199, 85, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .nav-item {
      transition: all 0.2s ease;
    }

    .nav-item.active {
      color: #06C755;
      border-bottom: 3px solid #06C755;
    }

    .status-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-pending {
      background: #FEF3C7;
      color: #92400E;
    }

    .status-investigating {
      background: #DBEAFE;
      color: #1E40AF;
    }

    .status-arrested {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-closed {
      background: #E5E7EB;
      color: #374151;
    }

    input,
    select,
    textarea {
      transition: all 0.2s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #06C755;
      box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
    }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    .heat-legend {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .heat-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>

<body class="h-full bg-gray-50">
  <div id="app" class="h-full flex flex-col overflow-auto"><!-- Header -->
    <header id="app-header" class="bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg sticky top-0 z-40">
      <div class="max-w-4xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
              üöî
            </div>
            <div>
              <h1 id="header-title" class="font-bold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢</h1>
              <p id="header-station" class="text-xs text-green-100">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£</p>
            </div>
          </div>
          <div id="user-profile" class="flex items-center gap-2">
            <div class="w-8 h-8 bg-white/20 rounded-full overflow-hidden"><img id="user-avatar" src="" alt="Profile"
                class="w-full h-full object-cover hidden">
              <div id="user-avatar-placeholder" class="w-full h-full flex items-center justify-center text-sm">
                üë§
              </div>
            </div><span id="user-name" class="text-sm hidden md:block">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
          </div>
        </div>
      </div>
    </header><!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-16 z-30">
      <div class="max-w-4xl mx-auto px-2">
        <div class="flex overflow-x-auto"><button onclick="showPage('report')"
            class="nav-item flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:text-green-600 active"
            data-page="report"> üìù ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô </button> <button onclick="showPage('list')"
            class="nav-item flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:text-green-600"
            data-page="list"> üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ </button> <button onclick="showPage('stats')"
            class="nav-item flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:text-green-600"
            data-page="stats"> üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ </button> <button onclick="showPage('analysis')"
            class="nav-item flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:text-green-600"
            data-page="analysis"> üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå </button>
        </div>
      </div>
    </nav><!-- Main Content -->
    <main class="flex-1 max-w-4xl mx-auto w-full px-4 py-4"><!-- Report Page -->
      <section id="page-report" class="page fade-in">
        <form id="report-form" class="space-y-4"><!-- Basic Info Card -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
                class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center text-sm">1</span>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h3>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏ß‡∏£ <span class="text-red-500">*</span></label>
                <select id="shift" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£</option>
                </select>
              </div>
              <div><label class="block text-sm text-gray-600 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ <span class="text-red-500">*</span></label>
                <select id="vehicle-type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  onchange="updateBrands()">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                  <option value="‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå">‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå</option>
                  <option value="‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå">‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</option>
                  <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
                </select>
              </div>
            </div>
          </div><!-- Vehicle Info Card -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
                class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-sm">2</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</h3>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-sm text-gray-600 mb-1">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏£‡∏ñ <span class="text-red-500">*</span></label>
                <select id="brand" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  onchange="checkOtherBrand()">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</option>
                </select>
              </div>
              <div id="brand-other-container" class="hidden"><label class="block text-sm text-gray-600 mb-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠
                  <span class="text-red-500">*</span></label> <input type="text" id="brand-other"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠">
              </div>
              <div><label class="block text-sm text-gray-600 mb-1">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label> <input type="text" id="model"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô PCX, City, Vios">
              </div>
              <div><label class="block text-sm text-gray-600 mb-1">‡∏™‡∏µ‡∏£‡∏ñ <span class="text-red-500">*</span></label>
                <select id="color" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  onchange="checkOtherColor()">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ</option>
                </select>
              </div>
              <div id="color-other-container" class="hidden"><label class="block text-sm text-gray-600 mb-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ
                  <span class="text-red-500">*</span></label> <input type="text" id="color-other"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏µ">
              </div>
              <div class="col-span-2"><label class="block text-sm text-gray-600 mb-1">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ <span
                    class="text-red-500">*</span></label> <input type="text" id="license-plate" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm uppercase"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏Ç 1234 ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£">
                <p id="license-error" class="text-xs text-red-500 mt-1 hidden">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>
              </div>
            </div>
          </div><!-- Location Card -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
                class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center text-sm">3</span>
              ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h3>
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-sm text-gray-600 mb-1">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span
                      class="text-red-500">*</span></label> <select id="area" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>
                  </select>
                </div>
                <div><label class="block text-sm text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span
                      class="text-red-500">*</span></label> <input type="date" id="incident-date" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
              </div>
              <div><label class="block text-sm text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span
                    class="text-red-500">*</span></label> <input type="text" id="location" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠ ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó">
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span
                      class="text-red-500">*</span></label> <input type="time" id="incident-time" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div><label class="block text-sm text-gray-600 mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label> <input type="text"
                    id="time-period" readonly
                    class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm text-gray-600"
                    placeholder="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
                </div>
              </div>
            </div>
          </div><!-- GPS Card -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
                class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-sm">4</span> ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
            </h3>
            <div class="space-y-3"><button type="button" onclick="getCurrentLocation()"
                class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2">
                <span id="gps-loading" class="hidden">
                  <svg class="animate-spin h-4 w-4" viewbox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                      fill="none"></circle>
                    <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                  </svg></span> <span id="gps-icon">üìç</span> ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô </button>
              <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-sm text-gray-600 mb-1">Latitude</label> <input type="text" id="latitude"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563"
                    oninput="validateGPS()">
                </div>
                <div><label class="block text-sm text-gray-600 mb-1">Longitude</label> <input type="text" id="longitude"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.5018"
                    oninput="validateGPS()">
                </div>
              </div>
              <p id="gps-error" class="text-xs text-red-500 hidden">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (Lat: 5.6-20.5, Lon:
                97.3-105.6)</p>
              <div id="map-link" class="hidden"><a id="google-maps-link" href="#" target="_blank"
                  rel="noopener noreferrer" class="text-sm text-blue-500 hover:text-blue-600 flex items-center gap-1">
                  üó∫Ô∏è ‡∏î‡∏π‡∏ö‡∏ô Google Maps </a>
              </div>
            </div>
          </div><!-- Details Card -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span
                class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center text-sm">5</span>
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><textarea id="details" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none"
              placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå, ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ñ‡∏ô‡∏£‡πâ‡∏≤‡∏¢, ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ..."></textarea>
          </div><!-- Submit Button --> <input type="hidden" id="edit-id" value=""> <button type="submit" id="submit-btn"
            class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold text-lg btn-primary shadow-lg">
            üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô </button>
        </form>
      </section><!-- List Page -->
      <section id="page-list" class="page hidden"><!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á</h3><button onclick="resetFilters()"
              class="text-sm text-gray-500 hover:text-gray-700">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          </div>
          <div class="space-y-3"><input type="text" id="search-input"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
              placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô..." oninput="filterReports()">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2"><select id="filter-status"
                class="px-2 py-2 border border-gray-300 rounded-lg text-xs" onchange="filterReports()">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="investigating">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô</option>
                <option value="arrested">‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡πÑ‡∏î‡πâ</option>
                <option value="closed">‡∏õ‡∏¥‡∏î‡∏Ñ‡∏î‡∏µ</option>
              </select> <select id="filter-shift" class="px-2 py-2 border border-gray-300 rounded-lg text-xs"
                onchange="filterReports()">
                <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏£</option>
              </select> <select id="filter-area" class="px-2 py-2 border border-gray-300 rounded-lg text-xs"
                onchange="filterReports()">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>
              </select> <select id="filter-date" class="px-2 py-2 border border-gray-300 rounded-lg text-xs"
                onchange="handleDateFilter()">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option value="custom">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</option>
              </select>
            </div>
            <div id="custom-date-range" class="hidden grid grid-cols-2 gap-2">
              <div><label class="block text-xs text-gray-500 mb-1">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date" id="date-from"
                  class="w-full px-2 py-1 border border-gray-300 rounded-lg text-xs" onchange="filterReports()">
              </div>
              <div><label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date" id="date-to"
                  class="w-full px-2 py-1 border border-gray-300 rounded-lg text-xs" onchange="filterReports()">
              </div>
            </div>
          </div>
        </div><!-- Export Buttons -->
        <div class="flex gap-2 mb-4"><button onclick="exportExcel()"
            class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-1">
            üìä Excel </button> <button onclick="exportPDF()"
            class="flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-1">
            üìÑ PDF </button>
        </div><!-- Results Count -->
        <div class="flex items-center justify-between mb-3">
          <p id="results-count" class="text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p><button onclick="loadReports()"
            class="text-sm text-green-600 hover:text-green-700 flex items-center gap-1"> üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä </button>
        </div><!-- Reports List -->
        <div id="reports-list" class="space-y-3"><!-- Skeleton Loading -->
          <div class="skeleton-card bg-white rounded-xl p-4">
            <div class="skeleton h-4 w-1/3 rounded mb-2"></div>
            <div class="skeleton h-3 w-2/3 rounded mb-2"></div>
            <div class="skeleton h-3 w-1/2 rounded"></div>
          </div>
          <div class="skeleton-card bg-white rounded-xl p-4">
            <div class="skeleton h-4 w-1/3 rounded mb-2"></div>
            <div class="skeleton h-3 w-2/3 rounded mb-2"></div>
            <div class="skeleton h-3 w-1/2 rounded"></div>
          </div>
        </div>
      </section><!-- Stats Page -->
      <section id="page-stats" class="page hidden"><!-- Summary Cards -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white card-hover">
            <p class="text-xs opacity-80">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <p id="stats-total" class="text-2xl font-bold">-</p>
          </div>
          <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl p-4 text-white card-hover">
            <p class="text-xs opacity-80">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
            <p id="stats-pending" class="text-2xl font-bold">-</p>
          </div>
          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white card-hover">
            <p class="text-xs opacity-80">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô</p>
            <p id="stats-investigating" class="text-2xl font-bold">-</p>
          </div>
          <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white card-hover">
            <p class="text-xs opacity-80">‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡πÑ‡∏î‡πâ</p>
            <p id="stats-arrested" class="text-2xl font-bold">-</p>
          </div>
        </div><!-- Charts -->
        <div class="space-y-4"><!-- Status Chart -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏î‡∏µ</h3>
            <div id="chart-status" class="h-64"></div>
          </div><!-- Time Period Chart -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ö‡πà‡∏≠‡∏¢</h3>
            <div id="chart-time" class="h-64"></div>
          </div><!-- Area Chart -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3">üìç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ö‡πà‡∏≠‡∏¢ (Top 10)</h3>
            <div id="chart-area" class="h-72"></div>
          </div><!-- Brand Chart -->
          <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
            <h3 class="font-semibold text-gray-800 mb-3">üöó ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡∏ö‡πà‡∏≠‡∏¢ (Top 10)</h3>
            <div id="chart-brand" class="h-72"></div>
          </div>
        </div>
      </section><!-- Analysis Page -->
      <section id="page-analysis" class="page hidden"><!-- Analysis Tabs -->
        <div class="bg-white rounded-xl shadow-sm mb-4 overflow-hidden">
          <div class="flex overflow-x-auto"><button onclick="showAnalysisTab('heatmap')"
              class="analysis-tab flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 border-b-2 border-transparent active"
              data-tab="heatmap"> üó∫Ô∏è Heat Map </button> <button onclick="showAnalysisTab('timeline')"
              class="analysis-tab flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 border-b-2 border-transparent"
              data-tab="timeline"> üìÖ Timeline </button> <button onclick="showAnalysisTab('compare')"
              class="analysis-tab flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 border-b-2 border-transparent"
              data-tab="compare"> üìà ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö </button> <button onclick="showAnalysisTab('report')"
              class="analysis-tab flex-1 min-w-max px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 border-b-2 border-transparent"
              data-tab="report"> üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô </button>
          </div>
        </div><!-- Heat Map Tab -->
        <div id="tab-heatmap" class="analysis-content fade-in">
          <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
            <h3 class="font-semibold text-gray-800 mb-3">üî• ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô - ‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3>
            <div class="mb-3 flex items-center justify-between">
              <div class="heat-legend"><span class="text-xs text-gray-500">‡∏ô‡πâ‡∏≠‡∏¢</span>
                <div class="heat-box" style="background: #22c55e;"></div>
                <div class="heat-box" style="background: #eab308;"></div>
                <div class="heat-box" style="background: #f97316;"></div>
                <div class="heat-box" style="background: #ef4444;"></div><span class="text-xs text-gray-500">‡∏°‡∏≤‡∏Å</span>
              </div>
            </div>
            <div id="heatmap-container" class="rounded-lg overflow-hidden border border-gray-200"><iframe
                id="heatmap-iframe" src="" class="w-full h-80 border-0" title="Heat Map"></iframe>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4">
            <h4 class="font-medium text-gray-800 mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h4>
            <div id="risk-areas" class="space-y-2"></div>
          </div>
        </div><!-- Timeline Tab -->
        <div id="tab-timeline" class="analysis-content hidden">
          <div class="bg-white rounded-xl shadow-sm p-4">
            <h3 class="font-semibold text-gray-800 mb-3">üìÖ Timeline ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="timeline-container" class="space-y-3 max-h-96 overflow-y-auto"></div>
          </div>
        </div><!-- Compare Tab -->
        <div id="tab-compare" class="analysis-content hidden">
          <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
            <h3 class="font-semibold text-gray-800 mb-3">üìà ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div><label class="block text-xs text-gray-500 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà 1</label> <input type="month"
                  id="compare-month1" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  onchange="updateComparison()">
              </div>
              <div><label class="block text-xs text-gray-500 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà 2</label> <input type="month"
                  id="compare-month2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  onchange="updateComparison()">
              </div>
            </div>
            <div id="chart-compare" class="h-64"></div>
          </div>
          <div id="compare-summary" class="grid grid-cols-2 gap-3"></div>
        </div><!-- Monthly Report Tab -->
        <div id="tab-report" class="analysis-content hidden">
          <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3><button onclick="generateMonthlyReport()"
                class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-all">
                üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô </button>
            </div>
            <div id="monthly-report-content" class="space-y-4 text-sm">
              <p class="text-gray-500 text-center py-8">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
          </div>
        </div>
      </section>
    </main><!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div><!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
      <div class="modal-backdrop absolute inset-0" onclick="closeDeleteModal()"></div>
      <div
        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-xl p-6 w-80 max-w-full slide-up">
        <div class="text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><span
              class="text-3xl">‚ö†Ô∏è</span>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
          <p class="text-sm text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
          <div class="flex gap-3"><button onclick="closeDeleteModal()"
              class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-all">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button id="confirm-delete-btn" onclick="confirmDelete()"
              class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all"> ‡∏•‡∏ö
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ==================== Configuration ====================
    const defaultConfig = {
      background_color: '#F9FAFB',
      surface_color: '#FFFFFF',
      text_color: '#1F2937',
      primary_color: '#06C755',
      card_color: '#FFFFFF',
      font_family: 'Prompt',
      font_size: 14,
      app_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢',
      station_name: '‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡∏ô‡∏¥‡∏Ñ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤',
      apps_script_url: 'https://script.google.com/macros/s/AKfycbxs3oWfi4tNCbO4nZ5q0aVIg5sTrdbWVcxkVGpWTuBYR87GcqBkm0BoUrnui0Ybsz1v/exec',
      liff_id: '2004593216-crBLYgWK'
    };

    let config = { ...defaultConfig };
    let reports = [];
    let filteredReports = [];
    let settings = { shifts: [], brands: {}, colors: [], areas: [] };
    let deleteTargetId = null;
    let liffProfile = null;
    let charts = {};

    // ==================== Element SDK Integration ====================
    async function initElementSdk() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
              { get: () => cfg.surface_color || defaultConfig.surface_color, set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
              { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); } },
              { get: () => cfg.card_color || defaultConfig.card_color, set: (v) => { cfg.card_color = v; window.elementSdk.setConfig({ card_color: v }); } }
            ],
            borderables: [],
            fontEditable: { get: () => cfg.font_family || defaultConfig.font_family, set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); } },
            fontSizeable: { get: () => cfg.font_size || defaultConfig.font_size, set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); } }
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['station_name', cfg.station_name || defaultConfig.station_name],
            ['apps_script_url', cfg.apps_script_url || defaultConfig.apps_script_url],
            ['liff_id', cfg.liff_id || defaultConfig.liff_id]
          ])
        });
        config = { ...defaultConfig, ...window.elementSdk.config };
      }
      applyConfig();
    }

    function applyConfig() {
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      document.body.style.backgroundColor = bgColor;
      document.body.style.color = textColor;
      document.body.style.fontFamily = `${fontFamily}, sans-serif`;
      document.body.style.fontSize = `${fontSize}px`;

      document.getElementById('header-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('header-station').textContent = config.station_name || defaultConfig.station_name;

      // Apply primary color to buttons and header
      const header = document.getElementById('app-header');
      header.style.background = `linear-gradient(to right, ${primaryColor}, ${adjustColor(primaryColor, -20)})`;

      // Apply card colors
      document.querySelectorAll('.bg-white').forEach(el => {
        if (!el.classList.contains('modal-backdrop')) {
          el.style.backgroundColor = cardColor;
        }
      });

      // Apply text colors
      document.querySelectorAll('.text-gray-800, .text-gray-600').forEach(el => {
        el.style.color = textColor;
      });

      // Apply primary color to buttons
      document.querySelectorAll('.bg-green-500, .bg-green-600').forEach(el => {
        el.style.backgroundColor = primaryColor;
      });

      document.querySelectorAll('.hover\\:bg-green-600, .hover\\:bg-green-700').forEach(el => {
        el.addEventListener('mouseenter', () => el.style.backgroundColor = adjustColor(primaryColor, -15));
        el.addEventListener('mouseleave', () => el.style.backgroundColor = primaryColor);
      });

      // Nav active state
      document.querySelectorAll('.nav-item.active').forEach(el => {
        el.style.color = primaryColor;
        el.style.borderBottomColor = primaryColor;
      });
    }

    function adjustColor(color, amount) {
      const hex = color.replace('#', '');
      const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
      const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
      const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
      return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }

    // ==================== LINE LIFF Integration ====================
    async function initLiff() {
      const liffId = config.liff_id || defaultConfig.liff_id;
      if (!liffId) {
        console.log('LIFF ID not configured');
        return;
      }

      try {
        await liff.init({ liffId });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          liffProfile = profile;
          updateUserProfile(profile);
        } else {
          liff.login();
        }
      } catch (error) {
        console.error('LIFF init error:', error);
      }
    }

    function updateUserProfile(profile) {
      const avatar = document.getElementById('user-avatar');
      const placeholder = document.getElementById('user-avatar-placeholder');
      const name = document.getElementById('user-name');

      if (profile.pictureUrl) {
        avatar.src = profile.pictureUrl;
        avatar.classList.remove('hidden');
        placeholder.classList.add('hidden');
      }
      name.textContent = profile.displayName;
      name.classList.remove('hidden');
    }

    async function shareToLine(report) {
      if (!liff.isApiAvailable('shareTargetPicker')) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ', 'error');
        return;
      }

      const message = {
        type: 'text',
        text: `üö® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢\n\n` +
          `üöó ${report.vehicleType} ${report.brand} ${report.model || ''}\n` +
          `üé® ‡∏™‡∏µ: ${report.color}\n` +
          `üìã ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${report.licensePlate}\n` +
          `üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${report.location}, ${report.area}\n` +
          `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(report.incidentDate)}\n` +
          `‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(report.incidentTime)}\n` +
          (report.latitude ? `üó∫Ô∏è ‡∏û‡∏¥‡∏Å‡∏±‡∏î: https://maps.google.com/?q=${report.latitude},${report.longitude}\n` : '') +
          `\nüìû ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡∏ô‡∏¥‡∏Ñ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤`
      };

      try {
        await liff.shareTargetPicker([message]);
        showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (error) {
        console.error('Share error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå', 'error');
      }
    }

    // ==================== Google Apps Script API ====================
    async function callApi(action, data = {}) {
      const url = config.apps_script_url || defaultConfig.apps_script_url;
      if (!url) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Apps Script URL', 'error');
        return null;
      }

      try {
        const response = await fetch(url, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action, ...data })
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('API Error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
        return null;
      }
    }

    async function loadSettings() {
      const result = await callApi('getSettings');
      if (result && result.success) {
        settings = result.data;
        populateDropdowns();
      } else {
        // Use default settings if API fails
        settings = {
          shifts: ['‡πÄ‡∏ß‡∏£ 1', '‡πÄ‡∏ß‡∏£ 2', '‡πÄ‡∏ß‡∏£ 3', '‡πÄ‡∏ß‡∏£ 4'],
          brands: {
            '‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå': ['Honda', 'Yamaha', 'Suzuki', 'Kawasaki', 'GPX', 'Vespa', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
            '‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå': ['Toyota', 'Honda', 'Nissan', 'Mazda', 'Mitsubishi', 'Isuzu', 'Ford', 'BMW', 'Benz', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
            '‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞': ['Toyota', 'Isuzu', 'Ford', 'Mitsubishi', 'Nissan', 'Mazda', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
          },
          colors: ['‡∏î‡∏≥', '‡∏Ç‡∏≤‡∏ß', '‡πÅ‡∏î‡∏á', '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', '‡πÄ‡∏ó‡∏≤', '‡πÄ‡∏á‡∏¥‡∏ô', '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡∏™‡πâ‡∏°', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡∏ä‡∏°‡∏û‡∏π', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
          areas: ['‡πÄ‡∏Ç‡∏ï‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á', '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ A', '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ B', '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°', '‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏£‡∏¥‡∏°‡∏Ñ‡∏•‡∏≠‡∏á', '‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å', '‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡∏£‡∏≠‡∏á']
        };
        populateDropdowns();
      }
    }

    function populateDropdowns() {
      // Shifts
      const shiftSelect = document.getElementById('shift');
      const filterShift = document.getElementById('filter-shift');
      shiftSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£</option>';
      filterShift.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏£</option>';
      settings.shifts.forEach(shift => {
        shiftSelect.innerHTML += `<option value="${shift}">${shift}</option>`;
        filterShift.innerHTML += `<option value="${shift}">${shift}</option>`;
      });

      // Colors
      const colorSelect = document.getElementById('color');
      colorSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ</option>';
      settings.colors.forEach(color => {
        colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
      });

      // Areas
      const areaSelect = document.getElementById('area');
      const filterArea = document.getElementById('filter-area');
      areaSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>';
      filterArea.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>';
      settings.areas.forEach(area => {
        areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
        filterArea.innerHTML += `<option value="${area}">${area}</option>`;
      });
    }

    function updateBrands() {
      const vehicleType = document.getElementById('vehicle-type').value;
      const brandSelect = document.getElementById('brand');
      brandSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</option>';

      if (vehicleType && settings.brands[vehicleType]) {
        settings.brands[vehicleType].forEach(brand => {
          brandSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
        });
      }

      document.getElementById('brand-other-container').classList.add('hidden');
    }

    function checkOtherBrand() {
      const brand = document.getElementById('brand').value;
      const container = document.getElementById('brand-other-container');
      if (brand === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        container.classList.remove('hidden');
        document.getElementById('brand-other').required = true;
      } else {
        container.classList.add('hidden');
        document.getElementById('brand-other').required = false;
      }
    }

    function checkOtherColor() {
      const color = document.getElementById('color').value;
      const container = document.getElementById('color-other-container');
      if (color === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        container.classList.remove('hidden');
        document.getElementById('color-other').required = true;
      } else {
        container.classList.add('hidden');
        document.getElementById('color-other').required = false;
      }
    }

    async function loadReports() {
      const result = await callApi('getReports');
      if (result && result.success) {
        reports = result.data || [];
        filteredReports = [...reports];
        renderReports();
        updateStats();
      } else {
        // Demo data if API fails
        reports = generateDemoData();
        filteredReports = [...reports];
        renderReports();
        updateStats();
      }
    }

    function generateDemoData() {
      const demoReports = [];
      const statuses = ['pending', 'investigating', 'arrested', 'closed'];
      const vehicleTypes = ['‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå', '‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', '‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞'];
      const brands = ['Honda', 'Toyota', 'Yamaha', 'Isuzu', 'Nissan'];
      const colors = ['‡∏î‡∏≥', '‡∏Ç‡∏≤‡∏ß', '‡πÅ‡∏î‡∏á', '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', '‡πÄ‡∏ó‡∏≤'];
      const areas = settings.areas.length > 0 ? settings.areas : ['‡πÄ‡∏Ç‡∏ï‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á', '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ A'];

      for (let i = 0; i < 25; i++) {
        const date = new Date();
        date.setDate(date.getDate() - Math.floor(Math.random() * 60));
        const hour = Math.floor(Math.random() * 24);
        const minute = Math.floor(Math.random() * 60);

        demoReports.push({
          id: `DEMO-${String(i + 1).padStart(4, '0')}`,
          shift: settings.shifts[Math.floor(Math.random() * settings.shifts.length)] || '‡πÄ‡∏ß‡∏£ 1',
          vehicleType: vehicleTypes[Math.floor(Math.random() * vehicleTypes.length)],
          brand: brands[Math.floor(Math.random() * brands.length)],
          model: ['PCX', 'Click', 'Vios', 'City', 'D-Max', 'Ranger'][Math.floor(Math.random() * 6)],
          color: colors[Math.floor(Math.random() * colors.length)],
          licensePlate: `${['‡∏Å‡∏Ç', '‡∏Å‡∏Ñ', '‡∏Å‡∏á', '‡∏Å‡∏à'][Math.floor(Math.random() * 4)]} ${Math.floor(1000 + Math.random() * 9000)} ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£`,
          area: areas[Math.floor(Math.random() * areas.length)],
          location: ['‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏•‡∏≤‡∏î', '‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏´‡πâ‡∏≤‡∏á', '‡∏ã‡∏≠‡∏¢‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', '‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠', '‡∏£‡∏¥‡∏°‡∏ñ‡∏ô‡∏ô‡πÉ‡∏´‡∏ç‡πà'][Math.floor(Math.random() * 5)],
          incidentDate: date.toISOString().split('T')[0],
          incidentTime: `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`,
          timePeriod: getTimePeriod(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`),
          latitude: 13.7 + Math.random() * 0.2,
          longitude: 100.4 + Math.random() * 0.2,
          details: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á',
          status: statuses[Math.floor(Math.random() * statuses.length)],
          reporter: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          createdAt: date.toISOString()
        });
      }

      return demoReports;
    }

    async function createReport(data) {
      const result = await callApi('createReport', { report: data });
      if (result && result.success) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadReports();
        return true;
      }
      return false;
    }

    async function updateReport(id, data) {
      const result = await callApi('updateReport', { id, report: data });
      if (result && result.success) {
        showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadReports();
        return true;
      }
      return false;
    }

    async function deleteReport(id) {
      const result = await callApi('deleteReport', { id });
      if (result && result.success) {
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadReports();
        return true;
      }
      return false;
    }

    async function updateStatus(id, status) {
      const result = await callApi('updateStatus', { id, status });
      if (result && result.success) {
        showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadReports();
        return true;
      }
      // Update locally if API fails
      const report = reports.find(r => r.id === id);
      if (report) {
        report.status = status;
        renderReports();
        updateStats();
        showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }
      return false;
    }

    // ==================== Page Navigation ====================
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.nav-item').forEach(n => {
        n.classList.remove('active');
        n.style.color = '';
        n.style.borderBottomColor = 'transparent';
      });

      const pageEl = document.getElementById(`page-${page}`);
      const navEl = document.querySelector(`[data-page="${page}"]`);

      if (pageEl) {
        pageEl.classList.remove('hidden');
        pageEl.classList.add('fade-in');
      }

      if (navEl) {
        navEl.classList.add('active');
        navEl.style.color = config.primary_color || defaultConfig.primary_color;
        navEl.style.borderBottomColor = config.primary_color || defaultConfig.primary_color;
      }

      if (page === 'list') loadReports();
      if (page === 'stats') updateStats();
      if (page === 'analysis') initAnalysis();
    }

    // ==================== Form Handling ====================
    document.getElementById('report-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const licensePlate = document.getElementById('license-plate').value.trim();
      if (licensePlate.length < 4) {
        document.getElementById('license-error').classList.remove('hidden');
        return;
      }
      document.getElementById('license-error').classList.add('hidden');

      const editId = document.getElementById('edit-id').value;
      const brand = document.getElementById('brand').value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
        ? document.getElementById('brand-other').value
        : document.getElementById('brand').value;
      const color = document.getElementById('color').value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
        ? document.getElementById('color-other').value
        : document.getElementById('color').value;

      const data = {
        shift: document.getElementById('shift').value,
        vehicleType: document.getElementById('vehicle-type').value,
        brand,
        model: document.getElementById('model').value,
        color,
        licensePlate: licensePlate.toUpperCase(),
        area: document.getElementById('area').value,
        location: document.getElementById('location').value,
        incidentDate: document.getElementById('incident-date').value,
        incidentTime: document.getElementById('incident-time').value,
        timePeriod: document.getElementById('time-period').value,
        latitude: document.getElementById('latitude').value,
        longitude: document.getElementById('longitude').value,
        details: document.getElementById('details').value,
        reporter: liffProfile?.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        reporterPicture: liffProfile?.pictureUrl || ''
      };

      // Validate duplicate license plate
      const existingReport = reports.find(r =>
        r.licensePlate.replace(/\s/g, '').toUpperCase() === licensePlate.replace(/\s/g, '').toUpperCase() &&
        r.id !== editId
      );

      if (existingReport) {
        showToast('‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';

      let success;
      if (editId) {
        success = await updateReport(editId, data);
      } else {
        success = await createReport(data);
      }

      if (success || !config.apps_script_url) {
        // Local save if API not configured
        if (!config.apps_script_url) {
          if (editId) {
            const idx = reports.findIndex(r => r.id === editId);
            if (idx !== -1) {
              reports[idx] = { ...reports[idx], ...data };
            }
          } else {
            const newReport = {
              id: `RPT-${Date.now()}`,
              ...data,
              status: 'pending',
              createdAt: new Date().toISOString()
            };
            reports.unshift(newReport);
          }
          showToast(editId ? '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        document.getElementById('report-form').reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('submit-btn').innerHTML = 'üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
        document.getElementById('time-period').value = '';
        document.getElementById('map-link').classList.add('hidden');
        document.getElementById('brand-other-container').classList.add('hidden');
        document.getElementById('color-other-container').classList.add('hidden');
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = editId ? 'üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' : 'üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
    });

    // Time calculation
    document.getElementById('incident-time').addEventListener('change', (e) => {
      const timePeriod = getTimePeriod(e.target.value);
      document.getElementById('time-period').value = timePeriod;
    });

    function getTimePeriod(time) {
      if (!time) return '';
      const hour = parseInt(time.split(':')[0]);
      if (hour >= 6 && hour < 12) return '‡πÄ‡∏ä‡πâ‡∏≤ (06:00-12:00)';
      if (hour >= 12 && hour < 18) return '‡∏ö‡πà‡∏≤‡∏¢ (12:00-18:00)';
      if (hour >= 18 && hour < 22) return '‡πÄ‡∏¢‡πá‡∏ô (18:00-22:00)';
      return '‡∏î‡∏∂‡∏Å (22:00-06:00)';
    }

    // Date validation
    document.getElementById('incident-date').addEventListener('change', (e) => {
      const selectedDate = new Date(e.target.value);
      const today = new Date();
      today.setHours(23, 59, 59, 999);

      if (selectedDate > today) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ', 'error');
        e.target.value = today.toISOString().split('T')[0];
      }
    });

    // Set max date
    document.getElementById('incident-date').max = new Date().toISOString().split('T')[0];

    // ==================== GPS Functions ====================
    function getCurrentLocation() {
      const loadingEl = document.getElementById('gps-loading');
      const iconEl = document.getElementById('gps-icon');

      loadingEl.classList.remove('hidden');
      iconEl.classList.add('hidden');

      if (!navigator.geolocation) {
        showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', 'error');
        loadingEl.classList.add('hidden');
        iconEl.classList.remove('hidden');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lng = position.coords.longitude.toFixed(6);

          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;

          validateGPS();
          showToast('‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

          loadingEl.classList.add('hidden');
          iconEl.classList.remove('hidden');
        },
        (error) => {
          console.error('GPS Error:', error);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ', 'error');
          loadingEl.classList.add('hidden');
          iconEl.classList.remove('hidden');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function validateGPS() {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lng = parseFloat(document.getElementById('longitude').value);
      const errorEl = document.getElementById('gps-error');
      const mapLinkEl = document.getElementById('map-link');
      const mapLink = document.getElementById('google-maps-link');

      if (isNaN(lat) || isNaN(lng)) {
        errorEl.classList.add('hidden');
        mapLinkEl.classList.add('hidden');
        return;
      }

      // Thailand bounds: Lat 5.6-20.5, Lon 97.3-105.6
      if (lat < 5.6 || lat > 20.5 || lng < 97.3 || lng > 105.6) {
        errorEl.classList.remove('hidden');
        mapLinkEl.classList.add('hidden');
      } else {
        errorEl.classList.add('hidden');
        mapLinkEl.classList.remove('hidden');
        mapLink.href = `https://maps.google.com/?q=${lat},${lng}`;
      }
    }

    // ==================== Reports List ====================
    function renderReports() {
      const container = document.getElementById('reports-list');
      const countEl = document.getElementById('results-count');

      container.innerHTML = '';
      countEl.textContent = `‡∏û‡∏ö ${filteredReports.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

      if (filteredReports.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üì≠</div>
            <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
          </div>
        `;
        return;
      }

      filteredReports.forEach((report, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-sm p-4 card-hover slide-up';
        card.style.animationDelay = `${idx * 50}ms`;
        card.style.backgroundColor = config.card_color || defaultConfig.card_color;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-lg">${getVehicleIcon(report.vehicleType)}</span>
                <span class="font-semibold text-gray-800">${report.brand} ${report.model || ''}</span>
                <span class="status-badge status-${report.status}">${getStatusText(report.status)}</span>
              </div>
              <p class="text-sm text-gray-600">üé® ${report.color} | üìã ${report.licensePlate}</p>
            </div>
            <span class="text-xs text-gray-400">${report.id}</span>
          </div>
          
          <div class="text-xs text-gray-500 mb-3 space-y-1">
            <p>üìç ${report.location}, ${report.area}</p>
            <p>üìÖ ${formatThaiDate(report.incidentDate)} ‚è∞ ${formatTime(report.incidentTime)} ${report.timePeriod || '-'}</p>
            <p>üë§ ${report.reporter || '-'} | üè¢ ${report.shift}</p>
            <p>üìä ${report.details}</p>
          </div>
          
          <div class="flex items-center gap-2 flex-wrap">
            ${report.latitude ? `
              <a href="https://maps.google.com/?q=${report.latitude},${report.longitude}" target="_blank" rel="noopener noreferrer" class="px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200 transition-all">
                üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
              </a>
            ` : ''}
            <button onclick="shareReport('${report.id}')" class="px-2 py-1 bg-green-100 text-green-600 rounded text-xs hover:bg-green-200 transition-all">
              üì§ ‡πÅ‡∏ä‡∏£‡πå
            </button>
            <button onclick="editReport('${report.id}')" class="px-2 py-1 bg-yellow-100 text-yellow-600 rounded text-xs hover:bg-yellow-200 transition-all">
              ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            <select onchange="handleStatusChange('${report.id}', this.value)" class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs border-0 cursor-pointer">
              <option value="" disabled selected>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
              <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option value="investigating" ${report.status === 'investigating' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô</option>
              <option value="arrested" ${report.status === 'arrested' ? 'selected' : ''}>‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡πÑ‡∏î‡πâ</option>
              <option value="closed" ${report.status === 'closed' ? 'selected' : ''}>‡∏õ‡∏¥‡∏î‡∏Ñ‡∏î‡∏µ</option>
            </select>
            <button onclick="openDeleteModal('${report.id}')" class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs hover:bg-red-200 transition-all">
              üóëÔ∏è ‡∏•‡∏ö
            </button>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function getVehicleIcon(type) {
      switch (type) {
        case '‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå': return 'üèçÔ∏è';
        case '‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå': return 'üöó';
        case '‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞': return 'üõª';
        default: return 'üöô';
      }
    }

    function getStatusText(status) {
      switch (status) {
        case 'pending': return '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
        case 'investigating': return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô';
        case 'arrested': return '‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡πÑ‡∏î‡πâ';
        case 'closed': return '‡∏õ‡∏¥‡∏î‡∏Ñ‡∏î‡∏µ';
        default: return status;
      }
    }

    function formatThaiDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString('th-TH', options);
    }

    function formatTime(time) {
      const d = new Date(time);
      return d.toLocaleTimeString('th-TH', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }


    // ==================== Filter Functions ====================
    function filterReports() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const statusFilter = document.getElementById('filter-status').value;
      const shiftFilter = document.getElementById('filter-shift').value;
      const areaFilter = document.getElementById('filter-area').value;
      const dateFilter = document.getElementById('filter-date').value;

      filteredReports = reports.filter(report => {
        // Search
        const matchSearch = !search ||
          report.licensePlate?.toLowerCase().includes(search) ||
          report.brand?.toLowerCase().includes(search) ||
          report.model?.toLowerCase().includes(search) ||
          report.location?.toLowerCase().includes(search) ||
          report.reporter?.toLowerCase().includes(search) ||
          report.area?.toLowerCase().includes(search);

        // Status
        const matchStatus = !statusFilter || report.status === statusFilter;

        // Shift
        const matchShift = !shiftFilter || report.shift === shiftFilter;

        // Area
        const matchArea = !areaFilter || report.area === areaFilter;

        // Date
        let matchDate = true;
        if (dateFilter && dateFilter !== 'custom') {
          const reportDate = new Date(report.incidentDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          switch (dateFilter) {
            case 'today':
              matchDate = reportDate.toDateString() === today.toDateString();
              break;
            case 'week':
              const weekAgo = new Date(today);
              weekAgo.setDate(weekAgo.getDate() - 7);
              matchDate = reportDate >= weekAgo;
              break;
            case 'month':
              const monthAgo = new Date(today);
              monthAgo.setMonth(monthAgo.getMonth() - 1);
              matchDate = reportDate >= monthAgo;
              break;
          }
        } else if (dateFilter === 'custom') {
          const dateFrom = document.getElementById('date-from').value;
          const dateTo = document.getElementById('date-to').value;
          if (dateFrom && dateTo) {
            const reportDate = new Date(report.incidentDate);
            matchDate = reportDate >= new Date(dateFrom) && reportDate <= new Date(dateTo);
          }
        }

        return matchSearch && matchStatus && matchShift && matchArea && matchDate;
      });

      renderReports();
    }

    function handleDateFilter() {
      const dateFilter = document.getElementById('filter-date').value;
      const customRange = document.getElementById('custom-date-range');

      if (dateFilter === 'custom') {
        customRange.classList.remove('hidden');
      } else {
        customRange.classList.add('hidden');
        filterReports();
      }
    }

    function resetFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-shift').value = '';
      document.getElementById('filter-area').value = '';
      document.getElementById('filter-date').value = '';
      document.getElementById('custom-date-range').classList.add('hidden');
      filteredReports = [...reports];
      renderReports();
    }

    // ==================== Report Actions ====================
    function shareReport(id) {
      const report = reports.find(r => r.id === id);
      if (report) {
        if (typeof liff !== 'undefined' && liff.isInClient()) {
          shareToLine(report);
        } else {
          // Fallback: Copy to clipboard
       
          //const text = `üö® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢\n${report.vehicleType} ${report.brand} ${report.model || ''}\n‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${report.licensePlate}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${report.location}, ${report.area}`;
         
         const text = `üö® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢\n\n` +
          `üöó ${report.vehicleType} ${report.brand} ${report.model || ''}\n` +
          `üé® ‡∏™‡∏µ: ${report.color}\n` +
          `üìã ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${report.licensePlate}\n` +
          `üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${report.location}, ${report.area}\n` +
          `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(report.incidentDate)}\n` +
          `‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(report.incidentTime)}\n` +
          (report.latitude ? `üó∫Ô∏è ‡∏û‡∏¥‡∏Å‡∏±‡∏î: https://maps.google.com/?q=${report.latitude},${report.longitude}\n` : '') +
          `\nüìû ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà ‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡∏ô‡∏¥‡∏Ñ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤`;


          navigator.clipboard.writeText(text).then(() => {
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'success');
          });
        }
      }
    }








    function editReport(id) {
      const report = reports.find(r => r.id === id);
      if (!report) return;

      // Switch to report page
      showPage('report');

      // Fill form
      document.getElementById('edit-id').value = report.id;
      document.getElementById('shift').value = report.shift;
      document.getElementById('vehicle-type').value = report.vehicleType;

      // Update brands dropdown
      updateBrands();

      setTimeout(() => {
        // Check if brand is in the list
        const brandSelect = document.getElementById('brand');
        const brandOptions = Array.from(brandSelect.options).map(o => o.value);

        if (brandOptions.includes(report.brand)) {
          brandSelect.value = report.brand;
        } else {
          brandSelect.value = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
          document.getElementById('brand-other-container').classList.remove('hidden');
          document.getElementById('brand-other').value = report.brand;
        }

        document.getElementById('model').value = report.model || '';

        // Check if color is in the list
        const colorSelect = document.getElementById('color');
        const colorOptions = Array.from(colorSelect.options).map(o => o.value);

        if (colorOptions.includes(report.color)) {
          colorSelect.value = report.color;
        } else {
          colorSelect.value = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
          document.getElementById('color-other-container').classList.remove('hidden');
          document.getElementById('color-other').value = report.color;
        }

        document.getElementById('license-plate').value = report.licensePlate;
        document.getElementById('area').value = report.area;
        document.getElementById('location').value = report.location;
        document.getElementById('incident-date').value = report.incidentDate;
        document.getElementById('incident-time').value = report.incidentTime;
        document.getElementById('time-period').value = report.timePeriod || '';
        document.getElementById('latitude').value = report.latitude || '';
        document.getElementById('longitude').value = report.longitude || '';
        document.getElementById('details').value = report.details || '';

        if (report.latitude && report.longitude) {
          validateGPS();
        }

        document.getElementById('submit-btn').innerHTML = 'üì§ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
      }, 100);

      showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'info');
    }

    function handleStatusChange(id, status) {
      if (status) {
        updateStatus(id, status);
      }
    }

    function openDeleteModal(id) {
      deleteTargetId = id;
      document.getElementById('delete-modal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      deleteTargetId = null;
      document.getElementById('delete-modal').classList.add('hidden');
    }

    async function confirmDelete() {
      if (deleteTargetId) {
        const success = await deleteReport(deleteTargetId);
        if (!success && !config.apps_script_url) {
          // Local delete if API not configured
          reports = reports.filter(r => r.id !== deleteTargetId);
          filteredReports = filteredReports.filter(r => r.id !== deleteTargetId);
          renderReports();
          updateStats();
          showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
        closeDeleteModal();
      }
    }

    // ==================== Export Functions ====================
    function exportExcel() {
      if (filteredReports.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', 'error');
        return;
      }

      const data = filteredReports.map(r => ({
        '‡∏£‡∏´‡∏±‡∏™': r.id,
        '‡πÄ‡∏ß‡∏£': r.shift,
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': r.vehicleType,
        '‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠': r.brand,
        '‡∏£‡∏∏‡πà‡∏ô': r.model || '-',
        '‡∏™‡∏µ': r.color,
        '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô': r.licensePlate,
        '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà': r.area,
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà': r.location,
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': r.incidentDate,
        '‡πÄ‡∏ß‡∏•‡∏≤': r.incidentTime,
        '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤': r.timePeriod || '-',
        'Latitude': r.latitude || '-',
        'Longitude': r.longitude || '-',
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': getStatusText(r.status),
        '‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': r.reporter || '-',
        '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': r.details || '-'
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢');
      XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢_${new Date().toISOString().split('T')[0]}.xlsx`);

      showToast('Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function exportPDF() {
      if (filteredReports.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', 'error');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');

      // Add Thai font support would require additional setup
      doc.setFontSize(16);
      doc.text('Vehicle Theft Report', 14, 15);
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleString('th-TH')}`, 14, 22);

      const tableData = filteredReports.map(r => [
        r.id,
        r.vehicleType,
        r.brand,
        r.licensePlate,
        r.area,
        r.incidentDate,
        getStatusText(r.status)
      ]);

      doc.autoTable({
        head: [['ID', 'Type', 'Brand', 'License', 'Area', 'Date', 'Status']],
        body: tableData,
        startY: 28,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [6, 199, 85] }
      });

      doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏´‡∏≤‡∏¢_${new Date().toISOString().split('T')[0]}.pdf`);
      showToast('Export PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // ==================== Statistics ====================
    function updateStats() {
      const total = reports.length;
      const pending = reports.filter(r => r.status === 'pending').length;
      const investigating = reports.filter(r => r.status === 'investigating').length;
      const arrested = reports.filter(r => r.status === 'arrested').length;

      document.getElementById('stats-total').textContent = total;
      document.getElementById('stats-pending').textContent = pending;
      document.getElementById('stats-investigating').textContent = investigating;
      document.getElementById('stats-arrested').textContent = arrested;

      renderStatusChart();
      renderTimeChart();
      renderAreaChart();
      renderBrandChart();
    }

    function renderStatusChart() {
      const statusCounts = {
        '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': reports.filter(r => r.status === 'pending').length,
        '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô': reports.filter(r => r.status === 'investigating').length,
        '‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡πÑ‡∏î‡πâ': reports.filter(r => r.status === 'arrested').length,
        '‡∏õ‡∏¥‡∏î‡∏Ñ‡∏î‡∏µ': reports.filter(r => r.status === 'closed').length
      };

      const options = {
        series: Object.values(statusCounts),
        chart: { type: 'donut', height: 250 },
        labels: Object.keys(statusCounts),
        colors: ['#F59E0B', '#3B82F6', '#10B981', '#6B7280'],
        legend: { position: 'bottom' },
        plotOptions: {
          pie: {
            donut: {
              labels: {
                show: true,
                total: {
                  show: true,
                  label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                  formatter: () => reports.length
                }
              }
            }
          }
        }
      };

      if (charts.status) charts.status.destroy();
      charts.status = new ApexCharts(document.getElementById('chart-status'), options);
      charts.status.render();
    }

    function renderTimeChart() {
      const timeCounts = {
        '‡πÄ‡∏ä‡πâ‡∏≤ (06-12)': 0,
        '‡∏ö‡πà‡∏≤‡∏¢ (12-18)': 0,
        '‡πÄ‡∏¢‡πá‡∏ô (18-22)': 0,
        '‡∏î‡∏∂‡∏Å (22-06)': 0
      };

      reports.forEach(r => {
        if (r.timePeriod?.includes('‡πÄ‡∏ä‡πâ‡∏≤')) timeCounts['‡πÄ‡∏ä‡πâ‡∏≤ (06-12)']++;
        else if (r.timePeriod?.includes('‡∏ö‡πà‡∏≤‡∏¢')) timeCounts['‡∏ö‡πà‡∏≤‡∏¢ (12-18)']++;
        else if (r.timePeriod?.includes('‡πÄ‡∏¢‡πá‡∏ô')) timeCounts['‡πÄ‡∏¢‡πá‡∏ô (18-22)']++;
        else if (r.timePeriod?.includes('‡∏î‡∏∂‡∏Å')) timeCounts['‡∏î‡∏∂‡∏Å (22-06)']++;
      });

      const options = {
        series: [{ name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: Object.values(timeCounts) }],
        chart: { type: 'bar', height: 250 },
        plotOptions: {
          bar: { borderRadius: 8, horizontal: false, columnWidth: '60%' }
        },
        colors: ['#8B5CF6'],
        xaxis: { categories: Object.keys(timeCounts) },
        dataLabels: { enabled: true }
      };

      if (charts.time) charts.time.destroy();
      charts.time = new ApexCharts(document.getElementById('chart-time'), options);
      charts.time.render();
    }

    function renderAreaChart() {
      const areaCounts = {};
      reports.forEach(r => {
        areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
      });

      const sorted = Object.entries(areaCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const options = {
        series: [{ name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: sorted.map(s => s[1]) }],
        chart: { type: 'bar', height: 280 },
        plotOptions: {
          bar: { borderRadius: 4, horizontal: true }
        },
        colors: ['#F97316'],
        xaxis: { categories: sorted.map(s => s[0]) },
        dataLabels: { enabled: true }
      };

      if (charts.area) charts.area.destroy();
      charts.area = new ApexCharts(document.getElementById('chart-area'), options);
      charts.area.render();
    }

    function renderBrandChart() {
      const brandCounts = {};
      reports.forEach(r => {
        const key = `${r.brand} ${r.model || ''}`.trim();
        brandCounts[key] = (brandCounts[key] || 0) + 1;
      });

      const sorted = Object.entries(brandCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const options = {
        series: [{ name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: sorted.map(s => s[1]) }],
        chart: { type: 'bar', height: 280 },
        plotOptions: {
          bar: { borderRadius: 4, horizontal: true }
        },
        colors: ['#EC4899'],
        xaxis: { categories: sorted.map(s => s[0]) },
        dataLabels: { enabled: true }
      };

      if (charts.brand) charts.brand.destroy();
      charts.brand = new ApexCharts(document.getElementById('chart-brand'), options);
      charts.brand.render();
    }

    // ==================== Analysis ====================
    function showAnalysisTab(tab) {
      document.querySelectorAll('.analysis-content').forEach(c => c.classList.add('hidden'));
      document.querySelectorAll('.analysis-tab').forEach(t => {
        t.classList.remove('active');
        t.style.borderBottomColor = 'transparent';
        t.style.color = '';
      });

      const tabEl = document.getElementById(`tab-${tab}`);
      const btnEl = document.querySelector(`[data-tab="${tab}"]`);

      if (tabEl) {
        tabEl.classList.remove('hidden');
        tabEl.classList.add('fade-in');
      }

      if (btnEl) {
        btnEl.classList.add('active');
        btnEl.style.borderBottomColor = config.primary_color || defaultConfig.primary_color;
        btnEl.style.color = config.primary_color || defaultConfig.primary_color;
      }

      if (tab === 'heatmap') initHeatmap();
      if (tab === 'timeline') initTimeline();
      if (tab === 'compare') initComparison();
    }

    function initAnalysis() {
      showAnalysisTab('heatmap');
    }

    function initHeatmap() {
      // Calculate risk areas
      const areaCounts = {};
      reports.forEach(r => {
        areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
      });

      const sorted = Object.entries(areaCounts)
        .sort((a, b) => b[1] - a[1]);

      const total = reports.length || 1;
      const riskContainer = document.getElementById('risk-areas');
      riskContainer.innerHTML = '';

      sorted.slice(0, 5).forEach(([area, count], idx) => {
        const percent = ((count / total) * 100).toFixed(1);
        const riskLevel = idx === 0 ? '‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å' : idx === 1 ? '‡∏™‡∏π‡∏á' : idx === 2 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πà‡∏≥';
        const riskColor = idx === 0 ? 'bg-red-100 text-red-700' : idx === 1 ? 'bg-orange-100 text-orange-700' : idx === 2 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700';

        riskContainer.innerHTML += `
          <div class="flex items-center justify-between p-2 rounded-lg ${riskColor}">
            <div class="flex items-center gap-2">
              <span class="text-lg">${idx === 0 ? 'üî¥' : idx === 1 ? 'üü†' : idx === 2 ? 'üü°' : 'üü¢'}</span>
              <span class="font-medium">${area}</span>
            </div>
            <div class="text-right">
              <span class="font-bold">${count}</span> ‡∏Ñ‡∏î‡∏µ (${percent}%)
              <span class="text-xs block">${riskLevel}</span>
            </div>
          </div>
        `;
      });

      // Create simple heatmap visualization
      if (reports.length > 0 && reports.some(r => r.latitude && r.longitude)) {
        const centerLat = reports.reduce((sum, r) => sum + (parseFloat(r.latitude) || 0), 0) / reports.length;
        const centerLng = reports.reduce((sum, r) => sum + (parseFloat(r.longitude) || 0), 0) / reports.length;

        const mapUrl = `https://maps.google.com/maps?q=${centerLat || 13.7563},${centerLng || 100.5018}&z=12&output=embed`;
        document.getElementById('heatmap-iframe').src = mapUrl;
      } else {
        document.getElementById('heatmap-iframe').src = 'https://maps.google.com/maps?q=13.7563,100.5018&z=10&output=embed';
      }
    }

    function initTimeline() {
      const container = document.getElementById('timeline-container');
      container.innerHTML = '';

      // Get last 30 days reports
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      const recentReports = reports
        .filter(r => new Date(r.incidentDate) >= thirtyDaysAgo)
        .sort((a, b) => new Date(b.incidentDate) - new Date(a.incidentDate));

      if (recentReports.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</p>';
        return;
      }

      // Group by date
      const grouped = {};
      recentReports.forEach(r => {
        if (!grouped[r.incidentDate]) grouped[r.incidentDate] = [];
        grouped[r.incidentDate].push(r);
      });

      Object.entries(grouped).forEach(([date, items]) => {
        container.innerHTML += `
          <div class="border-l-4 border-green-500 pl-4 py-2">
            <div class="font-semibold text-gray-800 mb-2">${formatThaiDate(date)} (${items.length} ‡∏Ñ‡∏î‡∏µ)</div>
            <div class="space-y-2">
              ${items.map(r => `
                <div class="bg-gray-50 rounded-lg p-2 text-sm">
                  <div class="flex items-center gap-2">
                    <span>${getVehicleIcon(r.vehicleType)}</span>
                    <span class="font-medium">${r.brand} ${r.model || ''}</span>
                    <span class="status-badge status-${r.status}">${getStatusText(r.status)}</span>
                  </div>
                  <p class="text-gray-500 text-xs mt-1">üìç ${r.area} | ‚è∞ ${formatTime(r.incidentTime)}</p>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
    }

    function initComparison() {
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

      document.getElementById('compare-month1').value = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('compare-month2').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      updateComparison();
    }

    function updateComparison() {
      const month1 = document.getElementById('compare-month1').value;
      const month2 = document.getElementById('compare-month2').value;

      if (!month1 || !month2) return;

      const [year1, m1] = month1.split('-').map(Number);
      const [year2, m2] = month2.split('-').map(Number);

      const reports1 = reports.filter(r => {
        const d = new Date(r.incidentDate);
        return d.getFullYear() === year1 && d.getMonth() + 1 === m1;
      });

      const reports2 = reports.filter(r => {
        const d = new Date(r.incidentDate);
        return d.getFullYear() === year2 && d.getMonth() + 1 === m2;
      });

      // Render comparison chart
      const options = {
        series: [{
          name: getThaiMonth(m1) + ' ' + year1,
          data: [
            reports1.filter(r => r.status === 'pending').length,
            reports1.filter(r => r.status === 'investigating').length,
            reports1.filter(r => r.status === 'arrested').length,
            reports1.filter(r => r.status === 'closed').length
          ]
        }, {
          name: getThaiMonth(m2) + ' ' + year2,
          data: [
            reports2.filter(r => r.status === 'pending').length,
            reports2.filter(r => r.status === 'investigating').length,
            reports2.filter(r => r.status === 'arrested').length,
            reports2.filter(r => r.status === 'closed').length
          ]
        }],
        chart: { type: 'bar', height: 250 },
        plotOptions: { bar: { horizontal: false, columnWidth: '55%', borderRadius: 4 } },
        colors: ['#3B82F6', '#10B981'],
        xaxis: { categories: ['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô', '‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡πÑ‡∏î‡πâ', '‡∏õ‡∏¥‡∏î‡∏Ñ‡∏î‡∏µ'] },
        dataLabels: { enabled: true }
      };

      if (charts.compare) charts.compare.destroy();
      charts.compare = new ApexCharts(document.getElementById('chart-compare'), options);
      charts.compare.render();

      // Summary
      const change = reports2.length - reports1.length;
      const changePercent = reports1.length > 0 ? ((change / reports1.length) * 100).toFixed(1) : 0;

      document.getElementById('compare-summary').innerHTML = `
        <div class="bg-blue-50 rounded-xl p-4">
          <p class="text-xs text-blue-600 mb-1">${getThaiMonth(m1)} ${year1}</p>
          <p class="text-2xl font-bold text-blue-700">${reports1.length}</p>
          <p class="text-xs text-blue-500">‡∏Ñ‡∏î‡∏µ</p>
        </div>
        <div class="bg-green-50 rounded-xl p-4">
          <p class="text-xs text-green-600 mb-1">${getThaiMonth(m2)} ${year2}</p>
          <p class="text-2xl font-bold text-green-700">${reports2.length}</p>
          <p class="text-xs ${change >= 0 ? 'text-red-500' : 'text-green-500'}">
            ${change >= 0 ? '‚¨ÜÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‚¨áÔ∏è ‡∏•‡∏î'} ${Math.abs(change)} (${Math.abs(changePercent)}%)
          </p>
        </div>
      `;
    }

    function getThaiMonth(month) {
      const months = ['', '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      return months[month] || '';
    }

    function generateMonthlyReport() {
      const container = document.getElementById('monthly-report-content');

      // Get current month data
      const now = new Date();
      const currentMonthReports = reports.filter(r => {
        const d = new Date(r.incidentDate);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });

      // Last month for comparison
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const lastMonthReports = reports.filter(r => {
        const d = new Date(r.incidentDate);
        return d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
      });

      const total = currentMonthReports.length;
      const lastTotal = lastMonthReports.length;
      const change = total - lastTotal;
      const trend = change > 0 ? 'üìà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô' : change < 0 ? 'üìâ ‡∏•‡∏î‡∏•‡∏á' : '‚û°Ô∏è ‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°';

      // Risk areas
      const areaCounts = {};
      currentMonthReports.forEach(r => {
        areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
      });
      const topAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);

      // Time patterns
      const timeCounts = { '‡πÄ‡∏ä‡πâ‡∏≤': 0, '‡∏ö‡πà‡∏≤‡∏¢': 0, '‡πÄ‡∏¢‡πá‡∏ô': 0, '‡∏î‡∏∂‡∏Å': 0 };
      currentMonthReports.forEach(r => {
        if (r.timePeriod?.includes('‡πÄ‡∏ä‡πâ‡∏≤')) timeCounts['‡πÄ‡∏ä‡πâ‡∏≤']++;
        else if (r.timePeriod?.includes('‡∏ö‡πà‡∏≤‡∏¢')) timeCounts['‡∏ö‡πà‡∏≤‡∏¢']++;
        else if (r.timePeriod?.includes('‡πÄ‡∏¢‡πá‡∏ô')) timeCounts['‡πÄ‡∏¢‡πá‡∏ô']++;
        else if (r.timePeriod?.includes('‡∏î‡∏∂‡∏Å')) timeCounts['‡∏î‡∏∂‡∏Å']++;
      });
      const peakTime = Object.entries(timeCounts).sort((a, b) => b[1] - a[1])[0];

      // Top vehicles
      const vehicleCounts = {};
      currentMonthReports.forEach(r => {
        const key = `${r.brand} ${r.model || ''}`.trim();
        vehicleCounts[key] = (vehicleCounts[key] || 0) + 1;
      });
      const topVehicles = Object.entries(vehicleCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

      // Arrest rate
      const arrested = currentMonthReports.filter(r => r.status === 'arrested').length;
      const arrestRate = total > 0 ? ((arrested / total) * 100).toFixed(1) : 0;
      const pending = currentMonthReports.filter(r => r.status === 'pending' || r.status === 'investigating').length;

      container.innerHTML = `
        <div class="space-y-4">
          <!-- Summary -->
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
            <h4 class="font-bold text-lg mb-2">üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå - ${getThaiMonth(now.getMonth() + 1)} ${now.getFullYear() + 543}</h4>
            <div class="grid grid-cols-3 gap-3">
              <div class="text-center">
                <p class="text-3xl font-bold">${total}</p>
                <p class="text-xs opacity-80">‡∏Ñ‡∏î‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
              </div>
              <div class="text-center">
                <p class="text-xl font-bold">${trend}</p>
                <p class="text-xs opacity-80">${Math.abs(change)} ‡∏Ñ‡∏î‡∏µ</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold">${arrestRate}%</p>
                <p class="text-xs opacity-80">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°</p>
              </div>
            </div>
          </div>

          <!-- Risk Areas -->
          <div class="bg-red-50 rounded-xl p-4">
            <h4 class="font-bold text-red-700 mb-2">üö® ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</h4>
            <div class="space-y-2">
              ${topAreas.map(([area, count], i) => {
        const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        return `
                  <div class="flex items-center justify-between">
                    <span class="text-sm">${i + 1}. ${area}</span>
                    <span class="font-bold text-red-600">${count} ‡∏Ñ‡∏î‡∏µ (${percent}%)</span>
                  </div>
                `;
      }).join('')}
            </div>
          </div>

          <!-- Time Pattern -->
          <div class="bg-purple-50 rounded-xl p-4">
            <h4 class="font-bold text-purple-700 mb-2">‚è∞ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</h4>
            <p class="text-sm">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: <span class="font-bold text-purple-600">${peakTime ? `${peakTime[0]} (${peakTime[1]} ‡∏Ñ‡∏î‡∏µ)` : '-'}</span></p>
            <div class="mt-2 grid grid-cols-4 gap-2 text-center text-xs">
              ${Object.entries(timeCounts).map(([time, count]) => `
                <div class="bg-white rounded p-2">
                  <p class="font-bold">${count}</p>
                  <p class="text-gray-500">${time}</p>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Target Vehicles -->
          <div class="bg-orange-50 rounded-xl p-4">
            <h4 class="font-bold text-orange-700 mb-2">üéØ ‡∏£‡∏ñ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Top 5</h4>
            <div class="space-y-1">
              ${topVehicles.map(([vehicle, count], i) => `
                <div class="flex items-center justify-between text-sm">
                  <span>${i + 1}. ${vehicle}</span>
                  <span class="font-bold text-orange-600">${count} ‡∏Ñ‡∏±‡∏ô</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Patrol Plan -->
          <div class="bg-green-50 rounded-xl p-4">
            <h4 class="font-bold text-green-700 mb-2">‚úÖ ‡πÅ‡∏ú‡∏ô‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô</h4>
            <ul class="text-sm space-y-1 text-green-800">
              ${topAreas.slice(0, 2).map(([area]) => `
                <li>‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì <strong>${area}</strong></li>
              `).join('')}
              ${peakTime ? `<li>‚Ä¢ ‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ <strong>${peakTime[0]}</strong> ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</li>` : ''}
              <li>‚Ä¢ ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ö‡∏´‡∏ô‡∏µ</li>
            </ul>
          </div>

          <!-- Prevention -->
          <div class="bg-blue-50 rounded-xl p-4">
            <h4 class="font-bold text-blue-700 mb-2">üõ°Ô∏è ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</h4>
            <ul class="text-sm space-y-1 text-blue-800">
              <li>‚Ä¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</li>
              <li>‚Ä¢ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</li>
              <li>‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</li>
              ${topVehicles.length > 0 ? `<li>‚Ä¢ ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ ${topVehicles[0][0]} ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</li>` : ''}
            </ul>
          </div>

          <!-- Investigation -->
          <div class="bg-yellow-50 rounded-xl p-4">
            <h4 class="font-bold text-yellow-700 mb-2">üîç ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô</h4>
            <ul class="text-sm space-y-1 text-yellow-800">
              <li>‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏î‡∏µ</li>
              <li>‚Ä¢ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡πÄ‡∏´‡∏ï‡∏∏</li>
              <li>‚Ä¢ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏≥‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</li>
              <li>‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</li>
            </ul>
          </div>

          <!-- Evaluation -->
          <div class="bg-gray-100 rounded-xl p-4">
            <h4 class="font-bold text-gray-700 mb-2">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</h4>
            <div class="grid grid-cols-3 gap-3 text-center">
              <div>
                <p class="text-2xl font-bold text-green-600">${arrestRate}%</p>
                <p class="text-xs text-gray-500">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-yellow-600">${pending}</p>
                <p class="text-xs text-gray-500">‡∏Ñ‡∏î‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-blue-600">${change >= 0 ? '+' : ''}${change}</p>
                <p class="text-xs text-gray-500">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p>
              </div>
            </div>
          </div>
        </div>
      `;

      showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // ==================== Toast Notifications ====================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');

      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };

      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      };

      toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 min-w-64`;
      toast.innerHTML = `
        <span>${icons[type]}</span>
        <span class="text-sm">${message}</span>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ==================== Initialize ====================
    async function init() {
      await initElementSdk();
      await loadSettings();

      // Set default date
      document.getElementById('incident-date').value = new Date().toISOString().split('T')[0];

      // Initialize LIFF if available
      if (config.liff_id) {
        await initLiff();
      }

      // Load initial data
      await loadReports();

      showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
    }

    init();
  </script>
  <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9c4d526a53c57b40',t:'MTc2OTU3MDA5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>